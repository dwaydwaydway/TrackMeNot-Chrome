<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>tmn_search.js - TrackMeNot JS Docs</title>
    
    
    
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://trackmenot.io" target="_blank" class="menu-item" id="TMN Official Site" >Project Website</a></h2><h3>Modules</h3><ul><li><a href="TRACKMENOT.module_TMNSearch.html">TMNSearch</a><ul class='methods'><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.trim#~trim">trim</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.cerr#~cerr">cerr</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.roll#~roll">roll</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.randomElt#~randomElt">randomElt</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.getElementsByAttrValue#~getElementsByAttrValue">getElementsByAttrValue</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.getEngineById#~getEngineById">getEngineById</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.getYahooId#~getYahooId">getYahooId</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.chooseElt#~chooseElt">chooseElt</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.getTMNTab#~getTMNTab">getTMNTab</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.deleteTab#~deleteTab">deleteTab</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.createTab#~createTab">createTab</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.iniTab#~iniTab">iniTab</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.monitorBurst#~monitorBurst">monitorBurst</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.checkForSearchUrl#~checkForSearchUrl">checkForSearchUrl</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.isBursting#~isBursting">isBursting</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.randomQuery#~randomQuery">randomQuery</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.validateFeeds#~validateFeeds">validateFeeds</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.extractQueries#~extractQueries">extractQueries</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.isBlackList#~isBlackList">isBlackList</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.queryOk#~queryOk">queryOk</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.addQuery#~addQuery">addQuery</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.filterKeyWords#~filterKeyWords">filterKeyWords</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.addRssTitles#~addRssTitles">addRssTitles</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.readDHSList#~readDHSList">readDHSList</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.doRssFetch#~doRssFetch">doRssFetch</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.getSubQuery#~getSubQuery">getSubQuery</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.getQuery#~getQuery">getQuery</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.updateOnErr#~updateOnErr">updateOnErr</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.updateOnSend#~updateOnSend">updateOnSend</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.createLog#~createLog">createLog</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.doSearch#~doSearch">doSearch</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.sendQuery#~sendQuery">sendQuery</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.queryToURL#~queryToURL">queryToURL</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.rescheduleOnError#~rescheduleOnError">rescheduleOnError</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.reschedule#~reschedule">reschedule</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.scheduleNextSearch#~scheduleNextSearch">scheduleNextSearch</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.enterBurst#~enterBurst">enterBurst</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.saveOptions#~saveOptions">saveOptions</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.stopTMN#~stopTMN">stopTMN</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.formatNum#~formatNum">formatNum</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.add_log#~add_log">add_log</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.sendClickEvent#~sendClickEvent">sendClickEvent</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.startTMN#~startTMN">startTMN</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.handleRequest#~handleRequest">handleRequest</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.setDefaultOptions#~setDefaultOptions">setDefaultOptions</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.initQueries#~initQueries">initQueries</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.onError#~onError">onError</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.logGotItem#~logGotItem">logGotItem</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.getStorage#~getStorage">getStorage</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.setDefaultEngines#~setDefaultEngines">setDefaultEngines</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.restoreOptions#~restoreOptions">restoreOptions</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.updateOptions#~updateOptions">updateOptions</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.setEngines#~setEngines">setEngines</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#.restoreQueries#~restoreQueries">restoreQueries</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#._logStorageChange#~_logStorageChange">_logStorageChange</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#._restoreTMN#~_restoreTMN">_restoreTMN</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#._getEngine#~_getEngine">_getEngine</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#._getQueries#~_getQueries">_getQueries</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#._getStorage#~_getStorage">_getStorage</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#._resetSettings#~_resetSettings">_resetSettings</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNSearch.html#._preserveTMNTab#~_preserveTMNTab">_preserveTMNTab</a></li></ul></li><li><a href="TRACKMENOT.module_TMNInjected.html">TMNInjected</a><ul class='methods'><li data-type='method'><a href="TRACKMENOT.module_TMNInjected.html#.testAd_google#~testAd_google">testAd_google</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNInjected.html#.testAd_yahoo#~testAd_yahoo">testAd_yahoo</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNInjected.html#.testAd_yahoo#~testAd_yahoo">testAd_yahoo</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNInjected.html#.roll#~roll">roll</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNInjected.html#.cout#~cout">cout</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNInjected.html#.stripTags#~stripTags">stripTags</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNInjected.html#.pressEnter#~pressEnter">pressEnter</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNInjected.html#.downKey#~downKey">downKey</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNInjected.html#.pressKey#~pressKey">pressKey</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNInjected.html#.inputChar#~inputChar">inputChar</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNInjected.html#.releaseKey#~releaseKey">releaseKey</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNInjected.html#.releaseKey#~releaseKey">releaseKey</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNInjected.html#.releaseKey#~releaseKey">releaseKey</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNInjected.html#.clickElt#~clickElt">clickElt</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNInjected.html#.getElementsByAttrValue#~getElementsByAttrValue">getElementsByAttrValue</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNInjected.html#.getCommonWords#~getCommonWords">getCommonWords</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNInjected.html#.getTimingArray#~getTimingArray">getTimingArray</a></li><li data-type='method'><a href="TRACKMENOT.module_TMNInjected.html#.typeQuery#~typeQuery">typeQuery</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#toggleTabFrame">toggleTabFrame</a></li><li><a href="global.html#updateEngineList">updateEngineList</a></li><li><a href="global.html#TMNShowEngines">TMNShowEngines</a></li><li><a href="global.html#saveOptions">saveOptions</a></li><li><a href="global.html#logGotItem">logGotItem</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">tmn_search.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*******************************************************************************    
 This file is part of TrackMeNot (Chrome version).
 
 TrackMeNot is free software: you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
 the Free Software Foundation,  version 2 of the License.
 
 TrackMeNot is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 GNU General Public License for more details.
 
 You should have received a copy of the GNU General Public License
 along with Foobar.  If not, see &lt;http://www.gnu.org/licenses/>.
 ********************************************************************************/

var api;
if (chrome === undefined) {
    api = browser;
} else {
    api = chrome;
}

if (!TRACKMENOT)
    var TRACKMENOT = {};

/** The TRACKMENOT.TMNInjected object, 
 * which manages the search behavior and user simulation within TMN's tab,
 * or in the background in "stealth" search mode. Created in tmn_search.js
 * @exports TRACKMENOT.TMNInjected
 * @property {number} current_request_id - the id of the current search request, to prevent duplicate searches 
 * @property {string} tmnCurrentURL - the current search URL, used to keep track of the current search and for message handling/passing with the high-level TMNSearch object in trackmenot.js
 * @property {string} engine - the search engine used in the current search, parsed from the parameter set by TMNSearch
 * @property {string} last_engine - deprecated/unused
 *  */
TRACKMENOT.TMNInjected = function() {
    var debug_script = true;

    var current_request_id = 1;
    var tmnCurrentURL = '';
    var engine = '';
    var last_engine = ''; //unused
    //    var allEvents = ['blur','change','click','dblclick','DOMMouseScroll','focus','keydown','keypress','keyup','load','mousedown','mousemove','mouseout','mouseover','mouseup','select'];

    /** function that checks an anchorClass and anchorlink for characteristic properties
     * of a Google advertisement. 
     * @function testAd_google
     * @inner
     * @param {string} anchorClass
     * @param {string} anchorlink
     * @returns {Boolean} if the inputs look like a Google ad
     * */
    var testAd_google = function(anchorClass, anchorlink) {
        return (anchorlink
                &amp;&amp; (anchorClass === 'l' || anchorClass === 'l vst')
                &amp;&amp; anchorlink.indexOf('http') === 0
                &amp;&amp; anchorlink.indexOf('https') !== 0);
    }

    /** Deprecated function to check anchorClass and anchorlink for characteristic
     * properties of a yahoo ad. Always returns false
     * @function testAd_yahoo
     * @inner
     * @param {string} anchorClass
     * @param {string} anchorlink
     * @returns {Boolean} false
     * */
    var testAd_yahoo = function(anchorClass, anchorlink) {
		return false;
        //return (anchorClass === '\"yschttl spt\"' || anchorClass === 'yschttl spt');
    }

    /** Deprecated function to check anchorClass and anchorlink for characteristic
     * properties of a yahoo ad. Always returns false
     * @function testAd_yahoo
     * @inner
     * @param {string} anchorClass
     * @param {string} anchorlink
     * @returns {Boolean} false
     * */
    var testAd_aol = function(anchorClass, anchorlink) {
        return (anchorClass === '\"find\"' || anchorClass === 'find'
                &amp;&amp; anchorlink.indexOf('https') !== 0 &amp;&amp; anchorlink.indexOf('aol') &lt; 0);
    }

    var testAd_bing = function(anchorClass, anchorlink) {
        return (anchorlink
                &amp;&amp; anchorlink.indexOf('http') === 0
                &amp;&amp; anchorlink.indexOf('https') !== 0
                &amp;&amp; anchorlink.indexOf('msn') &lt; 0
                &amp;&amp; anchorlink.indexOf('live') &lt; 0
                &amp;&amp; anchorlink.indexOf('bing') &lt; 0
                &amp;&amp; anchorlink.indexOf('microsoft') &lt; 0
                &amp;&amp; anchorlink.indexOf('WindowsLiveTranslator') &lt; 0)
    }

    var testAd_baidu = function(anchorClass, anchorlink) {
        return (anchorlink
                &amp;&amp; anchorlink.indexOf('baidu') &lt; 0
                &amp;&amp; anchorlink.indexOf('https') !== 0);
    }

    var getButton_google = function(  ) {
        var button = getElementsByAttrValue(document, 'button', 'name', 'btnG');
        if (!button)
            button = getElementsByAttrValue(document, 'button', 'name', 'btnK');
        if (!button)
            button = getElementsByAttrValue(document, 'input', 'name', 'btnK');
        if (!button)
            button = getElementsByAttrValue(document, 'button', 'jsname', 'Tg7LZd');
            
        return button;
    }
    var getButton_yahoo = function(  ) {
        return getElementsByAttrValue(document, 'input', 'class', 'sbb');
    };
    var getButton_bing = function(  ) {
        return document.getElementById('sb_form_go');
    };
    var getButton_aol = function(  ) {
        return document.getElementById('csbbtn1');
    };
    var getButton_baidu = function(  ) {
        return getElementsByAttrValue(document, 'input', 'value', '????');
    };



    var SearchBox_google = function( ) {
        return getElementsByAttrValue(document, 'input', 'name', 'q');
    };
    var SearchBox_yahoo = function(  ) {
        return document.getElementById('yschsp');
    };
    var SearchBox_bing = function(  ) {
        return document.getElementById('sb_form_q');
    };
    var SearchBox_aol = function(  ) {
        return document.getElementById('csbquery1');
    };
    var SearchBox_baidu = function(  ) {
        return document.getElementById('kw');
    };


    var testad = function(engine_id,anchorClass, anchorlink) {
        switch (engine_id) {
            case 'google':
                return testAd_google(anchorClass, anchorlink);
                break;
            case 'yahoo':
                return testAd_yahoo(anchorClass, anchorlink);
                break;
            case 'bing':
                return testAd_bing(anchorClass, anchorlink);
                break;
            case 'baidu':
                return testAd_baidu(anchorClass, anchorlink);
                break;
            case 'aol':
                return testAd_aol(anchorClass, anchorlink);
                break;
            default:
                return null;
        }
    };
    
    var get_box = function(engine_id) {
        switch (engine_id) {
            case 'google':
                return SearchBox_google();
                break;
            case 'yahoo':
                return SearchBox_yahoo();
                break;
            case 'bing':
                return SearchBox_bing();
                break;
            case 'baidu':
                return SearchBox_baidu();
                break;
            case 'aol':
                return SearchBox_aol();
                break;
            default:
                return null;
        }
    };

    var get_button = function(engine_id) {
        console.log("searching for button with engine.id = " + engine_id);
        switch (engine_id) {
            case 'google':
                return getButton_google();
                break;
            case 'yahoo':
                return getButton_yahoo();
                break;
            case 'bing':
                return getButton_bing();
                break;
            case 'baidu':
                return getButton_baidu();
                break;
            case 'aol':
                return getButton_aol();
                break;
            default:
                return null;
        }
    };

    var engine2homepage = {
        'google': 'https://www.google.com/', 
        'yahoo': 'https://www.yahoo.com/', 
        'bing': 'https://www.bing.com/', 
        'baidu': 'https://www.baidu.com/'
    }

    var engines_regex = [
        {
            'id': 'google',
            'name': 'Google Searchs',
            "host": "(www\.google\.(co\.|com\.)?[a-z]{2,3})$",
            'regexmap': "^(https?:\/\/[a-z]+\.google\.(co\\.|com\\.)?[a-z]{2,3}\/(search){1}[\?]?.*?[&amp;\?]{1}q=)([^&amp;]*)(.*)$"
        },
        {
            'id': 'yahoo',
            'name': 'Yahoo! Search',
            "host": "([a-z.]*?search\.yahoo\.com)$",
            'regexmap': "^(https?:\/\/[a-z.]*?search\.yahoo\.com\/search.*?p=)([^&amp;]*)(.*)$"
        },
        {
            'id': 'bing',
            'name': 'Bing Search',
            "host": "(www\.bing\.com)$",
            'regexmap': "^(https?:\/\/www\.bing\.com\/search\?[^&amp;]*q=)([^&amp;]*)(.*)$"
        },
        {
            'id': 'baidu',
            'name': 'Baidu Search',
            "host": "(www\.baidu\.com)$",
            'regexmap': "^(https?:\/\/www\.baidu\.com\/s\?.*?wd=)([^&amp;]*)(.*)$"
        }
    ];

    /** Utility function that generates a random number between min and max, inclusive.
     * @function roll
     * @inner
     * @param {Number} min - the minimum
     * @param {Number} max - the maximum
     * */
    function roll(min, max) {
        return Math.floor(Math.random() * (max + 1)) + min;
    }

    /** Utility function to log a message to the console
     * @function cout
     * @inner
     * @param {string} msg
     * */
    function cout(msg) {
        console.log(msg);
    }
    // function debug(msg) {
    //     if (debug_script)
    //         console.log("debug: " + msg);
    // }

    /** Removes HTML tag characters from a string
     * @function stripTags
     * @inner
     * @param {string} htmlStr
     * @returns {string} the cleaned string
     * */
    function stripTags(htmlStr) {
        return htmlStr.replace(/(&lt;([^>]+)>)/ig, "");
    }



    /** Deprecated function to focus the browser on an input element and press enter, 
     * using a timed set of interactions to simulate a user.
     * @function pressEnter
     * @inner
     * @param elt - the element to pressEnter within
     * @deprecated
     * */
    function pressEnter(elt) {
        var timers = getTimingArray();
        var evtDown = new KeyboardEvent("keydown", {"keyCode": 13});
        window.setTimeout(function() {
            elt.dispatchEvent(evtDown);
        }, timers[0]);
        var evtPress = new KeyboardEvent("keypress", {"keyCode": 13});
        window.setTimeout(function() {
            elt.dispatchEvent(evtPress);
        }, timers[1]);
        var evtUp = new KeyboardEvent("keyup", {"keyCode": 13});
        window.setTimeout(function() {
            elt.dispatchEvent(evtUp);
        }, timers[2]);
        window.setTimeout(sendPageLoaded, timers[3])
    }
    ;

    /** Dispatch a keydown event on the first letter of the input string chara 
     * into the input searchBox, simulating a keydown of that character on the keyboard.
     * Used to type queries into the searchBox.
     * @function downKey
     * @inner
     * @param {string} chara - a string to type the first letter of
     * @param searchBox - the DOM element to dispatch the keyboardEvent to
     * */ 
    function downKey(chara, searchBox) {
        var charCode = chara[chara.length - 1].charCodeAt(0);
        var evtDown = new KeyboardEvent("keydown", {"charCode": charCode});
        searchBox.dispatchEvent(evtDown);
    }

    /** Dispatch a keypress event on the first letter of the input string chara 
     * into the input searchBox, simulating a keypress of that character on the keyboard.
     * Used to type queries into the searchBox.
     * @function pressKey
     * @inner
     * @param {string} chara - a string to type the first letter of
     * @param searchBox - the DOM element to dispatch the keyboardEvent to
     * */ 
    function pressKey(chara, searchBox) {
        var charCode = chara[chara.length - 1].charCodeAt(0);
        var evtPress = new KeyboardEvent("keypress", {"charCode": charCode});
        searchBox.dispatchEvent(evtPress);
    }

    /** Dispatch a "input" event into the input searchBox, Used in typing queries into the searchBox.
     * @function inputChar
     * @inner
     * @param {string} chara - unused param
     * @param searchBox - the DOM element to dispatch the input event to
     * */ 
    function inputChar(chara, searchBox) {
        var ev = document.createEvent("Event");
        ev.initEvent("input", true, false);
        searchBox.dispatchEvent(ev);
    }

    /** Dispatch a keyup event on the first letter of the input string chara 
     * into the input searchBox, simulating a keyup/release of that character on the keyboard.
     * Used to type queries into the searchBox.
     * @function releaseKey
     * @inner
     * @param {string} chara - a string to release the first letter of
     * @param searchBox - the DOM element to dispatch the keyup event to
     * */ 
    function releaseKey(chara, searchBox) {
        var charCode = chara[chara.length - 1].charCodeAt(0);
        var evtUp = new KeyboardEvent("keyup", {"charCode": charCode});
        searchBox.dispatchEvent(evtUp);
    }

    /** Dispatch a keyup event on the first letter of the input string chara 
     * into the input searchBox, simulating a keyup/release of that character on the keyboard.
     * Used to type queries into the searchBox.
     * @function releaseKey
     * @inner
     * @param {string} chara - a string to release the first letter of
     * @param searchBox - the DOM element to dispatch the keyup event to
     * */ 
    function simulateClick(engine) {

        var clickIndex = roll(0, 9);
        if (!document || document === "undefined")
            return;
        var pageLinks = document.getElementsByTagName("a");


        var anchorLink, anchorClass;
        var j = 0;
        for (var i = 0; i &lt; pageLinks.length; i++) {
            if (pageLinks[i].hasAttribute("orighref"))
                anchorLink = pageLinks[i].getAttribute("orighref");
            else
                anchorLink = pageLinks[i].getAttribute("href");
            anchorClass = pageLinks[i].getAttribute("class");
            var link = stripTags(pageLinks[i].innerHTML);
            if (testad(engine.id, anchorClass, anchorLink)) {
                j++;
                if (j === clickIndex) {
                    var logEntry = JSON.stringify({
                        'type': 'click',
                        "engine": engine.id,
                        'query': link,
                        'id': current_request_id
                    });
                    add_log(logEntry);
                    try {
                        clickElt(pageLinks[i]);
                        console.log("link clicked");
                    } catch (e) {
                        add_log({
                            'type': 'ERROR',
                            'query': "[ERROR in tmn_search.js] error opening click-through request for: " + e.message,
                            'engine': engine, 
                        });
                        console.log("error opening click-through request for " + e);
                    }
                    return;
                }
            }
        }
    }


    /** Dispatch a keyup event on the first letter of the input string chara 
     * into the input searchBox, simulating a keyup/release of that character on the keyboard.
     * Used to type queries into the searchBox.
     * @function releaseKey
     * @inner
     * @param {string} chara - a string to release the first letter of
     * @param searchBox - the DOM element to dispatch the keyup event to
     * */ 
    function clickButton(searchButton) {
        // var button = get_button(engine.id, document);
        searchButton.click();
        // clickElt(button);
        console.log("send page loaded");
        sendPageLoaded();
    }


    /** Given a browser DOM element, perform a sequence of mousedown, mouseup, and click events,
     * timed to simulate a real user.
     * @function clickElt
     * @inner
     * @param elt - the element to click on
     * */ 
    function clickElt(elt) {
        if (!elt)
            return;
        var timers = getTimingArray();
        var evtDown = new MouseEvent("mousedown");
        window.setTimeout(function() {
            elt.dispatchEvent(evtDown);
        }, timers[0]);
        var evtUp = new MouseEvent("mouseup");
        window.setTimeout(function() {
            elt.dispatchEvent(evtUp);
        }, timers[1]);
        var evtCl = new MouseEvent("click");
        window.setTimeout(function() {
            elt.dispatchEvent(evtCl);
        }, timers[2]);

    }

    /** Used to get search button and boxes, by checking each element
     * of a particular type (e.g. "input") with a particular attribute name (e.g. "name"),
     * with a search engine specific value indicating implicitly it serves a designated 
     * search engine role in the interface.
     * @function getElementsByAttrValue
     * @inner
     * @param dom - the document object model of a webpage
     * @param {string} nodeType - the tag name of the type of node (e.g. "input")
     * @param {string} attrName - the attribute name associated with a particular role-identifying value
     * @param {string} nodeValue - the target value of the attribute
     * @returns either the first matching element or null
     * */
    function getElementsByAttrValue(dom, nodeType, attrName, nodeValue) {
        var outlines = dom.getElementsByTagName(nodeType);
        for (var i = 0; i &lt; outlines.length; i++) {
            if (outlines[i].hasAttribute(attrName) &amp;&amp; outlines[i].getAttribute(attrName) === nodeValue)
                return outlines[i];
        }
        return null;
    }

    /** Find all the matching words between a searchValue and the nextQuery.
     * Used to maintain a consistent progression search value state as the query is entered,
     * and prevent duplicate word entry.
     * @function getCommonWords
     * @inner
     * @param {string} searchValue - the current value of the search box
     * @param {string} nextQuery - the next query to send
     * @returns {array} the array of matching words between the searchValue and nextQuery
     * */
    function getCommonWords(searchValue, nextQuery) {
        var searched = searchValue.split(' ');
        var tosearch = nextQuery.split(' ');
        var result = [];
        result = result.concat(searched.filter(function(x) {
            return (tosearch.indexOf(x) >= 0);
        }));
        return result;
    }

    /** Generates a random set of 5 timeout values between 0 and 30 milliseconds to create user like
     * timing for keyboard interactions.
     * @function getTimingArray
     * @inner
     * @returns {array} an array of 5 timeout values between 0 and 30 (JS numbers representing milliseconds)
     * */
    function getTimingArray() {
        var timers = [];
        for (var i = 0; i &lt; 5; i++) {
            timers.push(Math.floor(Math.random() * 30));
        }
        return timers.sort();
    }


    /** Types a given query recursively until completing the query, and then clicks the search box to send it.
     * @function typeQuery
     * @inner
     * @param {string} queryToSend - the query to send
     * @param {string} currIndex - the index of what's been typed, within the queryToSend
     * @param searchBox - the DOM search box
     * @param {string} chara - the remaining untyped part of the queryToSend
     * @param isIncr - unused input variable, set to false in the recursive case
     * @param searchButton - the DOM searchButton element to click when the query has been completed typing
     * @returns {array} an array of 5 timeout values between 0 and 30 (JS numbers representing milliseconds)
     * */
    function typeQuery(queryToSend, currIndex, searchBox, chara, isIncr, searchButton) {
        var nextPress;
        tmnCurrentQuery = queryToSend;

        clickElt(searchBox);
        searchBox.focus();
        if (currIndex &lt; queryToSend.length) {
            // var suggestElt = getQuerySuggestion(doc);	
            /*if (false &amp;&amp; Math.random() &lt; 0.02 &amp;&amp; suggestElt.length > 0) {
                var index_ = roll(0, suggestElt.length - 1);
                selectElt(suggestElt[index_], searchBox);
                clickElt(suggestElt[index_]);
                blurElt(searchBox);
                updateStatus(searchBox.value);
                return;
            } else {*/
                var newWord = queryToSend.substring(currIndex).split(" ")[0];
                if (newWord.length > 1 &amp;&amp; (currIndex === 0 || queryToSend[currIndex - 1] === " ")) {
                    console.log("Checking if " + newWord + " appears in " + searchBox.value);
                    if (!(searchBox.value.indexOf(newWord + " ") &lt; 0)) {
                        console.log("It\s in");
                        if (searchBox.value.indexOf(newWord, currIndex) >= 0) {
                            console.log("We\re movine of " + newWord.length + 1);
                            searchBox.selectionEnd += newWord.length + 1;
                            searchBox.selectionStart = searchBox.selectionEnd;
                        }
                        currIndex += newWord.length;
                        updateStatus(searchBox.value);
                        nextPress = roll(50, 250);
                        window.setTimeout(typeQuery, nextPress, queryToSend, currIndex, searchBox, chara.slice(), false, searchButton);
                        return;
                    }
                }
                chara.push(queryToSend[currIndex]);
                var timers = getTimingArray();
                var textvalue = queryToSend[currIndex];
                window.setTimeout(function() {
                    return downKey(chara, searchBox);
                }, timers[0]);
                window.setTimeout(function() {
                    return pressKey(chara, searchBox);
                }, timers[1]);
                window.setTimeout(function() {
                    return inputChar(chara, searchBox);
                }, timers[2]);
                window.setTimeout(function() {
                    searchBox.value += textvalue;
                }, timers[3]);
                window.setTimeout(function() {
                    return releaseKey(chara, searchBox);
                }, timers[4]);
                updateStatus(searchBox.value);
                currIndex++;
                nextPress = roll(50, 250);
                window.setTimeout(typeQuery, nextPress, queryToSend, currIndex, searchBox, chara.slice(), false, searchButton);
           // }
        } else {
            updateStatus(searchBox.value);
            nextPress = roll(10, 30);
            window.setTimeout(clickButton, nextPress, searchButton);
            // if (Math.random() &lt; 0.5)
            //     window.setTimeout(clickButton, nextPress);
            // else
            //     window.setTimeout(pressEnter, nextPress, searchBox);
            //window.setTimeout( sendCurrentURL, nextpress+1) //no function called sendCurrentURL
        }
    }


    function queryToURL(url, query) {
        if (Math.random() &lt; 0.9)
            query = query.toLowerCase();
        var urlQuery = url.replace('|', query);
        urlQuery = urlQuery.replace(/ /g, '+');
        var encodedUrl = encodeURI(urlQuery);
        encodedUrl = encodedUrl.replace(/%253/g, "%3");

        return encodedUrl;
    }


    function sendQuery(engine, queryToSend, tmn_mode, url) {
        console.log("[tmn_search.js] sendQuery");
        var host;
        try {
            host = window.location.host;
        } catch (ex) {
            host = "";
        }
        var reg = new RegExp(engine.host, 'g');
        var encodedUrl = queryToURL(url, queryToSend);
        var logEntry = JSON.stringify({
            'type': 'query',
            "engine": engine.id,
            'mode': tmn_mode,
            'query': queryToSend,
            'id': current_request_id
        });
        add_log(logEntry);
        updateStatus(queryToSend);
        if (host === "" || !host.match(reg)) {
            try {
                window.location.href = encodedUrl;
                return encodedUrl;
            } catch (ex) {
                console.log("Caught exception: " + ex);
                add_log({
                    'type': 'ERROR',
                    'query': "[ERROR in tmn_search.js] " + ex.message,
                    'engine': engine, 
                });
                api.runtime.sendMessage({
                    "url": encodedUrl
                });
                return null;
            }

        } else {
            var searchBox = get_box(engine.id);
            var searchButton = get_button(engine.id);
            console.log("searchBox: " + JSON.stringify(searchBox));
            console.log("get_button: " + JSON.stringify(get_button));
            if (searchBox &amp;&amp; searchButton &amp;&amp; engine !== 'aol') {
                searchBox.value = getCommonWords(searchBox.value, queryToSend).join(' ');
                searchBox.selectionStart = 0;
                searchBox.selectionEnd = 0;
                var chara = new Array();
                typeQuery(queryToSend, 0, searchBox, chara, false, searchButton);
                return null;
            } else {
                tmnCurrentURL = encodedUrl;
                console.log("The searchbox can not be found ");
                try {
                    window.location.href = encodedUrl;
                    return encodedUrl;
                } catch (ex) {
                    console.log("Caught exception: " + ex);
                    add_log({
                        'type': 'ERROR',
                        'query': "[ERROR in tmn_search.js] Caught exception: " + ex.message,
                        'engine': engine, 
                    });
                    api.runtime.sendMessage({
                        "url": encodedUrl
                    });
                    return null;
                }

            }
        }
    }




    function isSafeHost(host) {
        for (var i = 0; i &lt; engines_regex.length; i++) {
            var eng = engines_regex[i];
            var regex = eng.host;
            // console.log("regex :" + regex);
            if (host.match(regex)) {
                return true;
            }
        }
        return true; // used to be false
    }



    function sendPageLoaded() {
        var req = {};
        req.tmn = "pageLoaded";
        if ( document.defaultView.document.body) {
            req.html = document.defaultView.document.body.innerHTML;
        } else {
            req.html = null;
        }
        api.runtime.sendMessage(req);
    }


    function add_log(msg) {
        api.runtime.sendMessage({tmnLog: msg});
    }

    function updateStatus(msg) {
        var req = {
            "updateStatus": msg
        };
        api.runtime.sendMessage(req);
    }


    function getTMNCurrentURL() {
        api.runtime.sendMessage({
            tmn: "currentURL"
        },
        function(response) {
            setTMNCurrentURL(response.url);
        });
    }

    function setTMNCurrentURL(url) {
        tmnCurrentURL = url;
        console.log("Current TMN loc: " + tmnCurrentURL);
        var message = {
            "url": tmnCurrentURL
        };
        api.runtime.sendMessage(message);
        sendPageLoaded();
    }


    return {
        handleRequest: function(request, sender, sendResponse) {
            if (request.tmnQuery) {
                last_request_id = current_request_id;
                if (last_request_id >= request.tmnID) {
                    console.log("Duplicate queries ignored");
                    return;
                }
                var engine = JSON.parse(request.tmnEngine);
                console.log("Received: " + request.tmnQuery + " on engine: " + engine.id + " mode: " + request.tmnMode + " tmn id " + request.tmnID);
                
                // if(last_engine != engine){
                //     console.log("Changed search engine, visiting " + engine2homepage[engine.id]);
                //     try {
                //         window.location.href = engine2homepage[engine.id];
                //         setTMNCurrentURL(engine2homepage[engine.id]);
                //         console.log("Visited" + engine2homepage[engine.id]);
                //     } catch (ex) {
                //         console.log("Failed visiting " + engine2homepage[engine.id] + " first. Error: " + ex)
                //     }                    
                // }

                var tmn_query = request.tmnQuery;
                var tmn_mode = request.tmnMode;
                current_request_id = request.tmnID;
                var tmn_URLmap = request.tmnUrlMap;
                var encodedurl = sendQuery(engine, tmn_query, tmn_mode, tmn_URLmap);

                // last_engine = engine;
                
                if (encodedurl !== null) {
                    console.log("scheduling next set url");
                    setTMNCurrentURL(encodedurl);
                }
            }
            if (request.click_eng) {
                try {
                    simulateClick(request.click_eng);
                } catch(ex) {
                    add_log({
                        'type': 'ERROR',
                        'query': "[ERROR in tmn_search.js] Failed so click on results: " + ex.message,
                        'engine': engine, 
                    });
                    console.log("Failed so click on results");
                }
            }
            return; // snub them.
        },
        checkIsActiveTab: function() {
            api.runtime.sendMessage({
                tmn: "isActiveTab"
            }, function(response) {
                if ( response &amp;&amp; response.isActive) {
                    console.log('Message sent from active tab');
                    TRACKMENOT.TMNInjected.hasLoaded();
                }
            });
       },
        hasLoaded: function() {
            var host = window.location.host;
            if (!isSafeHost(host)) {
                console.log("Host " + host + " is unsafe");
                window.stop();
                //history.go(-1);
            }
            //  sendPageLoaded();
            getTMNCurrentURL();
        }
    };
}();
TRACKMENOT.TMNInjected.checkIsActiveTab();
api.runtime.onMessage.addListener(TRACKMENOT.TMNInjected.handleRequest);


</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.0</a> on Fri Dec 02 2022 11:53:22 GMT-0500 (Eastern Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>



    <script src="./../.link-fixer.js"></script>
    
</body>
</html>
